{% extends "base.html" %}
{% block title %}<title>{{ book.title }}</title>{% endblock %}
{% block content %}
{% load static %}
{% load i18n %}
{% if format ==  "epub" %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.5/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/epubjs/dist/epub.min.js"></script>
<link rel="stylesheet" type="text/css" href="{% static 'css/epub.css' %}">

    <!-- <div id="title"></div> -->
    <select id="toc"></select>
    <div id="viewer" class="spreads"></div>
    <a id="prev" href="#prev" class="arrow"><</a>
    <a id="next" href="#next" class="arrow">></a>
    <script nonce="{{ request.csp_nonce }}">
        // use this to get the current location, after every nav change
        //    loc  =  rendition.location.start.cfi;
        // push that to django
        // when entering the page, fetch that location and
        // use rendition.display(loc)
      var params = URLSearchParams && new URLSearchParams(document.location.search.substring(1));
      var url = params && params.get("url") && decodeURIComponent(params.get("url"));
      var currentSectionIndex = (params && params.get("loc")) ? params.get("loc") : undefined;

      // Load the opf
      var book = ePub("/UserLibrary/{{ url }}");
      var rendition = book.renderTo("viewer", {
        width: "100%",
        height: 600,
        spread: "always"
      });

      rendition.display(currentSectionIndex);

      book.ready.then(function() {

        var next = document.getElementById("next");

        next.addEventListener("click", function(e){
          book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
          e.preventDefault();
        }, false);

        var prev = document.getElementById("prev");
        prev.addEventListener("click", function(e){
          book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
          e.preventDefault();
        }, false);

        var keyListener = function(e){

          // Left Key
          if ((e.keyCode || e.which) == 37) {
            book.package.metadata.direction === "rtl" ? rendition.next() : rendition.prev();
          }

          // Right Key
          if ((e.keyCode || e.which) == 39) {
            book.package.metadata.direction === "rtl" ? rendition.prev() : rendition.next();
          }

        };

        rendition.on("keyup", keyListener);
        document.addEventListener("keyup", keyListener, false);

      })

      var title = document.getElementById("title");

      rendition.on("rendered", function(section){
        var current = book.navigation && book.navigation.get(section.href);

        if (current) {
          var $select = document.getElementById("toc");
          var $selected = $select.querySelector("option[selected]");
          if ($selected) {
            $selected.removeAttribute("selected");
          }

          var $options = $select.querySelectorAll("option");
          for (var i = 0; i < $options.length; ++i) {
            let selected = $options[i].getAttribute("ref") === current.href;
            if (selected) {
              $options[i].setAttribute("selected", "");
            }
          }
        }

      });

      rendition.on("relocated", function(location){
        console.log(location);

        var next = book.package.metadata.direction === "rtl" ?  document.getElementById("prev") : document.getElementById("next");
        var prev = book.package.metadata.direction === "rtl" ?  document.getElementById("next") : document.getElementById("prev");

        if (location.atEnd) {
          next.style.visibility = "hidden";
        } else {
          next.style.visibility = "visible";
        }

        if (location.atStart) {
          prev.style.visibility = "hidden";
        } else {
          prev.style.visibility = "visible";
        }

      });

      rendition.on("layout", function(layout) {
        let viewer = document.getElementById("viewer");

        if (layout.spread) {
          viewer.classList.remove('single');
        } else {
          viewer.classList.add('single');
        }
      });

      window.addEventListener("unload", function () {
        console.log("unloading");
        this.book.destroy();
      });

      book.loaded.navigation.then(function(toc){
              var $select = document.getElementById("toc"),
                      docfrag = document.createDocumentFragment();

              toc.forEach(function(chapter) {
                  var option = document.createElement("option");
                  option.textContent = chapter.label;
                  option.setAttribute("ref", chapter.href);

                  docfrag.appendChild(option);
              });

              $select.appendChild(docfrag);

              $select.onchange = function(){
                      var index = $select.selectedIndex,
                              url = $select.options[index].getAttribute("ref");
                      rendition.display(url);
                      return false;
              };

          });




    </script>

{% elif format == "pdf" %}

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.12.313/pdf.min.js" integrity="sha512-qa1o08MA0596eSNsnkRv5vuGloSKUhY09O31MY2OJpODjUVlaL0GOJJcyt7J7Z61FiEgHMgBkH04ZJ+vcuLs/w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<link rel="stylesheet" type="text/css" href="{% static 'css/pdf.css' %}">
<div>
    <button id="prev">Previous</button>
    <button id="next">Next</button>
    &nbsp; &nbsp;
    <span>Page: <span id="page_num"></span> / <span id="page_count"></span></span>
  </div>
<canvas id="pdf" source="/UserLibrary/{{ url }}"></canvas>
</body>


<script src="{% static 'js/pdf.js' %}"></script>

{% else %}

<p>Sorry, {{format}} can't be viewed online yet. Please <a href="/UserLibrary/{{ url }}">download the file instead</a> for offline viewing</p>
{% endif %}

{% endblock %}